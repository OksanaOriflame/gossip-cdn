# Gossip-cdn
Decentralized System course project

Студенты:
- Гильмутдинов Даниил
- Фрицлер Виктор
- Кузьмин Роман
- Рогачев Евгений

## Проблема

Децентрализованая система для хранения файлов на нескольких узлах. Файлы представлены веб-страницами, каждая в своей директории.

## Выбранное решение

CDN - набор узлов, запущенных на разных серверах, каждый дает доступ к хранящимся у неё страницам. Состояние актуализируется при помощи протокола gossip: узлы делятся сплетнями, в которых рассказывают, какая новая информация у них есть.

Для каждой версии страницы создается дерево Меркла, корневой хэш которого позволяет определить, что новая версия на получающем узле соответствует версии, которая была у делившегося узла.

В директории каждой страницы должен присутствовать файл info.json с id и name, для того чтобы узлы могли говорить об одних и тех же страницах и знали их имя для пользователей. Id должны быть уникальны.

Для отдельно взятой страницы узел хранит у себя все её версии. Версия представлена корневым хэшем и набором хэшей листьев дерева Меркла, которые дают понять, какие файлы относятся к этой странице. Получается импровизированное персистентное дерево Меркла.

Каждый файл страницы хранится с хэшом от своего контента в качестве имени, таким образом даже если файл с одинаковым контентом встречается дважды в рамках одной версии или в разных версиях, его контент будет храниться только в одном экземпляре.

Общение узлов реализовано через сокеты

При обмене данными общаются два узла - делящийся (Д) и слушающий (С):
1. Д случайным образом выбирает С и страницу, про которую он хочет рассказать.
2. Д спрашивает последнюю версию страницы с выбранным id.
3. С отвечает последнюю версию или None, если он её ещё не знает.
4. Д определяет, есть ли у него более новая версия, чем у С. Если нет, то общение завершается.
5. Если новая версия есть, то Д пытается рассказать о следущей. Это не обязательно сразу последняя, потому что все узлы должны иметь полную историю версий, чтобы уметь понимать, о чем говорить.
6. Пункт 5 повторяется, пока Д не доведет версию С до своей последней

Для передачи следущей версии узел собирает набор операций типов add, modify и remove, которые содержат информацию о том, что делать с файлами. Modify передает весь файл, а не то, что нужно изменить (потому что это долго и непонятно, насколько нужно делать), таким образом по сути является синонимом для последовательных операций remove и add.

Если после применения всех операций у нового получившегося дерева Меркла корневой хэш не совпадает с хэшем, переданным в том же запросе, то версия откатывается, сообщается об ошибке.

Один из узлов - bootstrap узел. Он хранит у себя информацию по существующим узлам, остальные могут узнать у него про соседей, с которыми можно общаться. Каждый узел при запуске сообщает bootstrap-у о своем присутствии. Тот периодически пингует узлы, о которых знает, чтобы не рассказывать про тех, кто уже не работает.

## Что проверяли, каков результат

Запускали bootstrap и несколько узлов, создавали на каждом разные страницы с разным состоянием версий, смотрели, как узлы рассказывают друг другу о своих страницах. После последних правок узлы обменивались правильно, все версии страниц совпали, данные у всех постепенно синхронизировались. Возможно, посмотрели не все сценарии.

Пока что слабая часть - сетевое взаимодействие. Не успели продумать все ситуации, поэтому сложно рассчитывать, что узлы смогут стабильно работать долгое время не падая. Скорее всего на починку этого уйдет пару дней, если в этом есть смысл.

Пока не реализован фронт, состояние данных можно посмотреть только по файлам у нод. Предполагалось, что страницы будут храниться в виде статических файлов, которые просто будут дергаться из нужной директории. Скорее всего это не так долго делать.

## Как запустить самому

Всё написано на python, так что он должен быть. В основном использовались стандартные библиотеки. Остальные зависимости нужно поставить из requirements.txt

Далее из корневой директории gossip-cdn:

Должна быть запущена bootstrap нода:
``` 
python bootstrap.py --port 5555
```
Если не указать порт будет 3333 по умолчанию.
Если уже есть известный работающий бутстрап-узел, то запускать новый нет смысла.

Далее необходимо наличие директории , в которой будут храниться страницы. Структура должна быть следущей:
```
└── cdn_data
    └── page1
        ├── info.json
        ├── file1.html
        ├── file2.html
        ...
    └── page2
        ├── info.json
        ├── file1.html
        ├── file1.css
        ...
    ...
```

Сама директория (здесь - cdn_data) содержит директории со страницами. В каждой директории страницы обязательно должен находиться файл info.json. Остальные файлы - файлы страницы, к ним нет требований. После первого запуска в директории появится папка для хранения версий - .versions. Чтобы не потерять версии, рекомендуется её не удалять.

Структура info.json:
```json
{
    "id": "page_id1",
    "name": "page_name1"
}
```

Если нужно добавить к странице новые данные, создав новую версию, то следует расположить в той же папке файлы в новом состоянии, не трогая .versions и info.json. После повторного запуска узла будет создана новая версия. Также новая версия создастся при запуске скрипта:
```
python update_versions.py --cdn-folder cdn_data
```
По ключу --cdn-folder передается расположение директории с данными узла.

Ни один способ пока не дает возможности обновить данные без перезагрузки узла, в том числе update_versions.py

Непосредственно запуск узла:
```
python main.py port [-h] [--cdn-folder CDN_FOLDER] [--bootstrap-addr BOOTSTRAP_ADDR]
```

port - порт, который узел будет слушать для получения сплетен от других узлов. Обязательный параметр.

По ключу --cdn-folder передается расположение директории с данными узла. По умолчанию это папка cdn_data в директории, в которой лежит скрипт main.py

По ключу --bootstrap-addr BOOTSTRAP_ADDR ожидается адрес бутстрап-узла в формате {IP}:{PORT}. По умолчанию - localhost:3333
